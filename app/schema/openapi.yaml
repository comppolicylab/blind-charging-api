openapi: '3.1.1'

info:
  title: Blind Charging API
  description: |
    This API lets an application communicate with the CPL Blind Charging module via an HTTP REST API.
  version: 0.8.1
  contact:
    name: Joe Nudell
    email: jnudell@hks.harvard.edu
  license:
    name: MIT License
    url: https://opensource.org/license/mit/

tags:
  - name: redaction
    description: Operations related to document redaction.
  - name: review
    description: Operations related to reviewing documents.
  - name: experiments
    description: Operations related to research experiments.
  - name: extraction
    description: Operations related to document information extraction.
  - name: operations
    description: Operations related to the overall operation of the API.

paths:

  /health:
    get:
      summary: Health check
      description: |
        Check the health of the API.
      security: []
      tags:
        - operations
      operationId: health-check
      responses:
        "200":
          description: "OK"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIStatus"
        "500":
          description: "Not OK"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIStatus"

  /redact:
    post:
      summary: Redact a document
      description: |
        Submit a document for redaction. Redaction happens asynchronously and may take some time.
        When finished, the redacted document will be posted to the provided callback URL.

        A callback will be POSTed to the provided URL when the redaction process is completed for each input document.
        The callback will contain either `RedactionResultSuccess` or `RedactionResultError`.
      tags:
        - redaction
      operationId: redact-documents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RedactionRequest"
      responses:
        "201":
          description: "Accepted"
      callbacks:
        redactionComplete:
          '{$request.body#/callbackUrl}':
            post:
              summary: Redaction complete
              description: |
                This callback is made for each input document when it is finished.
              requestBody:
                required: true
                content:
                  application/json:
                    schema:
                      $ref: "#/components/schemas/RedactionResultCompleted"
              responses:
                "201":
                  description: "Accepted"

  /redact/{jurisdictionId}/{caseId}:
    get:
      summary: Get status of document redaction for a case.
      description: |
        Get the status of redaction for all documents in a case.
        This will return a list of document IDs and their redaction status.

        Generally, the push mechanism provided by the callback URL passed to the `/redact` endpoint should be used to determine when the redaction process is completed.
        However, this endpoint can be used to poll for the status of redaction if necessary.
      tags:
        - redaction
      operationId: get-redaction-status
      parameters:
        - name: jurisdictionId
          in: path
          required: true
          description: The jurisdiction ID
          schema:
            type: string
        - name: caseId
          in: path
          required: true
          description: The case ID
          schema:
            type: string
        - name: subjectId
          in: query
          required: false
          description: Optionally, filter status by a specific person.
          schema:
            type: string
      responses:
        "200":
          description: "OK"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RedactionStatus"

  /blindreview/{jurisdictionId}/{caseId}:
    get:
      summary: Get information about blind review for a given case.
      description: |
        This endpoint provides information about the blind review process for the given case.

        The payload will indicate whether blind review is required for this case.

        If blind review is required, this endpoint will also provide a list of redacted documents to present for review.
      tags:
        - review
      operationId: get-blind-review-info
      parameters:
        - name: jurisdictionId
          in: path
          required: true
          description: The jurisdiction ID
          schema:
            type: string
        - name: caseId
          in: path
          required: true
          description: The case ID
          schema:
            type: string
        - name: subjectId
          in: query
          required: false
          description: Optionally, the ID of a specific person
          schema:
            type: string
      responses:
        "200":
          description: "OK"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BlindReviewInfo"
        "424":
          description: "Documents are not processed yet"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /exposure:
    post:
      summary: Log an exposure event
      description: |
        This endpoint records which information is presented to attorneys and when, prior to them making a decision.

        Sending "exposure" events is required for all cases involved in research experiments, _both for blind review and also final review_.
      tags:
        - experiments
      operationId: log-exposure
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Exposure"
      responses:
        "201":
          description: "Accepted"

  /outcome:
    post:
      summary: Log an outcome event
      description: |
        This endpoint records the charging decisions made by attorneys, both for blind review and final review.

        Sending "outcome" events is required for all cases involved in research experiments, _regardless of whether the case is subject to blind review or not_.
      tags:
        - experiments
      operationId: log-outcome
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Review"
      responses:
        "201":
          description: "Accepted"

  /configs:
    get:
      summary: Get all experiment configurations
      description: |
        Get all the randomizations configurations for the API deployment.
      tags:
        - experiments
      operationId: get-all-configs
      responses:
        "200":
          description: "OK"
          content:
            application/json:
              schema:
                type: object
                properties:
                  configs:
                    type: array
                    items:
                      $ref: "#/components/schemas/ExperimentConfig"

  /config:
    get:
      summary: Get the experiment configuration
      description: |
        Get the active randomizations configuration for the API deployment.
      tags:
        - experiments
      operationId: get-active-config
      responses:
        "200":
          description: "OK"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExperimentConfig"
    post:
      summary: Update the experiment configuration
      description: |
        Update the randomizations configuration for the API deployment.
      tags:
        - experiments
      operationId: update-config
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NewExperimentConfig"
      responses:
        "201":
          description: "Accepted"
        "400":
          description: "Bad request"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /config/{version}/activate:
    post:
      summary: Activate an experiment configuration
      description: |
        Activate a specific randomizations configuration for the API deployment.
      tags:
        - experiments
      operationId: activate-config
      parameters:
        - name: version
          in: path
          required: true
          description: The version of the configuration to activate
          schema:
            type: string
      responses:
        "201":
          description: "OK"

  /config/{version}:
    get:
      summary: Get the experiment configuration
      description: |
        Get the randomizations configuration for the API deployment for a specific version.
      tags:
        - experiments
      operationId: get-config
      parameters:
        - name: version
          in: path
          required: true
          description: The version of the configuration to retrieve
          schema:
            type: string
      responses:
        "200":
          description: "OK"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExperimentConfig"

  /oauth2/token:
    post:
      summary: Get an access token
      security: []
      description: |
        Get an access token to use the API.

        This endpoint is only available if the `client_credentials` flow is configured
        for the API deployment. If it is not turned on, this endpoint will return a 501.
      tags:
        - operations
      operationId: get-access-token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ClientCredentialsTokenRequest"
      responses:
        "200":
          description: "OK"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClientCredentialsTokenResponse"
        "400":
          description: "Bad request"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "501":
          description: "Not implemented"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /oauth2/revoke:
    post:
      summary: Revoke an access token
      security: []
      description: |
        Revoke an access token.

        This endpoint is only available if the `client_credentials` flow is configured
        for the API deployment. If it is not turned on, this endpoint will return a 501.
      tags:
        - operations
      operationId: revoke-access-token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ClientCredentialsRevokeTokenRequest"
      responses:
        "200":
          description: "OK"
        "400":
          description: "Bad request"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "501":
          description: "Not implemented"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /extract:
    post:
      summary: Extract information from documents
      description: |
        Submit one or more PDF documents for structured information extraction.
        Extraction happens asynchronously and may take some time.

        A token is returned in the response that can be used to poll for the status and
        results of the extraction via the `GET /extract/{token}` endpoint.

        If a callback URL is provided for a document, the result will be POSTed to that URL
        when extraction is complete for that document. The callback will contain either
        `ExtractionResultSuccess` or `ExtractionResultError`.
      tags:
        - extraction
      operationId: extract-documents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExtractionRequest"
      responses:
        "201":
          description: "Accepted"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExtractionAccepted"
      callbacks:
        extractionComplete:
          '{$request.body#/documents/0/callbackUrl}':
            post:
              summary: Extraction complete
              description: |
                This callback is made for each input document when extraction is finished.
              requestBody:
                required: true
                content:
                  application/json:
                    schema:
                      $ref: "#/components/schemas/ExtractionResultCompleted"
              responses:
                "201":
                  description: "Accepted"

  /extract/{token}:
    get:
      summary: Get extraction results
      description: |
        Poll for the status and results of a document extraction request using the token
        returned from `POST /extract`.
      tags:
        - extraction
      operationId: get-extraction-status
      parameters:
        - name: token
          in: path
          required: true
          description: The token returned from the extraction request.
          schema:
            type: string
      responses:
        "200":
          description: "OK"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExtractionStatus"

security:
  - preshared: []
  - oauth2: []

# Data types
components:
  parameters: {}
  securitySchemes:
    preshared:
      type: http
      scheme: bearer
    oauth2:
      type: oauth2
      flows:
        clientCredentials:
          tokenUrl: /oauth2/token
          scopes:
            default: "The only scope available at this time."

  schemas:

    Error:
      type: object
      required:
        - message
      properties:
        message:
          type: string

    ExperimentConfig:
      type: object
      required:
        - version
        - blob
        - active
        - createdAt
        - updatedAt
      properties:
        version:
          type: string
        blob:
          type: string
        active:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        parent:
          type: string
        name:
          type: string
        description:
          type: string
        author:
          type: string

    NewExperimentConfig:
      type: object
      required:
        - blob
      properties:
        blob:
          type: string
        active:
          type: boolean
        parent:
          type: string
        name:
          type: string
        description:
          type: string

    ClientCredentialsRevokeTokenRequest:
      type: object
      required:
        - token
        - client_id
        - client_secret
      properties:
        token:
          type: string
        client_id:
          type: string
        client_secret:
          type: string

    ClientCredentialsTokenRequest:
      type: object
      required:
        - grant_type
        - client_id
        - client_secret
      properties:
        grant_type:
          type: string
          enum:
            - client_credentials
        client_id:
          type: string
        client_secret:
          type: string

    ClientCredentialsTokenResponse:
      type: object
      required:
        - access_token
        - token_type
        - expires_in
      properties:
        access_token:
          type: string
        token_type:
          type: string
        expires_in:
          type: integer

    DocumentLink:
      type: object
      required:
        - attachmentType
        - documentId
        - url
      properties:
        attachmentType:
          type: string
          enum:
            - LINK
        documentId:
          type: string
        url:
          type: string
          format: uri

    DocumentText:
      type: object
      required:
        - attachmentType
        - documentId
        - content
      properties:
        attachmentType:
          type: string
          enum:
            - TEXT
        documentId:
          type: string
        content:
          type: string

    DocumentContent:
      type: object
      required:
        - attachmentType
        - documentId
        - content
      properties:
        attachmentType:
          type: string
          enum:
            - BASE64
        documentId:
          type: string
        content:
          type: string

    DocumentJSON:
      type: object
      required:
        - attachmentType
        - documentId
        - content
      properties:
        attachmentType:
          type: string
          enum:
            - JSON
        documentId:
          type: string
        content:
          type: object
          required:
            - original
            - redacted
            - annotations
          properties:
            original:
              type: string
            redacted:
              type: string
            annotations:
              type: array
              items:
                type: object
                required:
                  - originalSpan
                  - redactedSpan
                  - valid
                  - openDelim
                  - closeDelim
                properties:
                  originalSpan:
                    type: array
                    items:
                      type: integer
                    minItems: 2
                    maxItems: 2
                  redactedSpan:
                    type: array
                    items:
                      type: integer
                    minItems: 2
                    maxItems: 2
                  valid:
                    type: boolean
                  openDelim:
                    type: [string, 'null']
                  closeDelim:
                    type: [string, 'null']

    OutputDocument:
      oneOf:
        - $ref: "#/components/schemas/DocumentLink"
        - $ref: "#/components/schemas/DocumentText"
        - $ref: "#/components/schemas/DocumentContent"
        - $ref: "#/components/schemas/DocumentJSON"
      discriminator:
        propertyName: attachmentType
        mapping:
          LINK: "#/components/schemas/DocumentLink"
          TEXT: "#/components/schemas/DocumentText"
          BASE64: "#/components/schemas/DocumentContent"
          JSON: "#/components/schemas/DocumentJSON"

    InputDocument:
      oneOf:
        - $ref: "#/components/schemas/DocumentLink"
        - $ref: "#/components/schemas/DocumentText"
        - $ref: "#/components/schemas/DocumentContent"
      discriminator:
        propertyName: attachmentType
        mapping:
          LINK: "#/components/schemas/DocumentLink"
          TEXT: "#/components/schemas/DocumentText"
          BASE64: "#/components/schemas/DocumentContent"

    BlindReviewInfo:
      type: object
      required:
        - jurisdictionId
        - caseId
        - blindReviewRequired
        - maskedSubjects
      properties:
        jurisdictionId:
          type: string
        caseId:
          type: string
        blindReviewRequired:
          type: boolean
        maskedSubjects:
          type: array
          items:
            $ref: "#/components/schemas/MaskedSubject"

    RedactionResultSuccess:
      type: object
      required:
        - jurisdictionId
        - caseId
        - maskedSubjects
        - inputDocumentId
        - redactedDocument
        - status
      properties:
        jurisdictionId:
          type: string
        caseId:
          type: string
        inputDocumentId:
          type: string
        maskedSubjects:
          type: array
          items:
            $ref: "#/components/schemas/MaskedSubject"
        redactedDocument:
          $ref: "#/components/schemas/OutputDocument"
        status:
          type: string
          enum:
            - COMPLETE

    RedactionResultError:
      type: object
      required:
        - jurisdictionId
        - caseId
        - maskedSubjects
        - inputDocumentId
        - error
        - status
      properties:
        jurisdictionId:
          type: string
        caseId:
          type: string
        inputDocumentId:
          type: string
        maskedSubjects:
          type: array
          items:
            $ref: "#/components/schemas/MaskedSubject"
        error:
          type: string
        status:
          type: string
          enum:
            - ERROR

    RedactionResultPending:
      type: object
      required:
        - jurisdictionId
        - caseId
        - maskedSubjects
        - inputDocumentId
        - status
      properties:
        jurisdictionId:
          type: string
        caseId:
          type: string
        inputDocumentId:
          type: string
        maskedSubjects:
          type: array
          items:
            $ref: "#/components/schemas/MaskedSubject"
        status:
          type: string
          enum:
            - QUEUED
            - PROCESSING
        statusDetail:
          type: string

    RedactionResultCompleted:
      description: |
        A completed redaction job. Similar to `RedactionResult`,
        but where it is not possible to see a result in an incomplete (pending or queued) state.
      oneOf:
        - $ref: "#/components/schemas/RedactionResultSuccess"
        - $ref: "#/components/schemas/RedactionResultError"
      discriminator:
        propertyName: status
        mapping:
          COMPLETE: "#/components/schemas/RedactionResultSuccess"
          ERROR: "#/components/schemas/RedactionResultError"

    RedactionResult:
      description: |
        Information about a redaction job.
      oneOf:
        - $ref: "#/components/schemas/RedactionResultSuccess"
        - $ref: "#/components/schemas/RedactionResultError"
        - $ref: "#/components/schemas/RedactionResultPending"
      discriminator:
        propertyName: status
        mapping:
          COMPLETE: "#/components/schemas/RedactionResultSuccess"
          ERROR: "#/components/schemas/RedactionResultError"
          QUEUED: "#/components/schemas/RedactionResultPending"
          PROCESSING: "#/components/schemas/RedactionResultPending"

    RedactionStatus:
      description: |
        The status of redaction for a case.
      type: object
      required:
        - jurisdictionId
        - caseId
        - requests
      properties:
        jurisdictionId:
          type: string
        caseId:
          type: string
        requests:
          type: array
          items:
            $ref: "#/components/schemas/RedactionResult"

    HumanName:
      description: A structured representation of someone's name. Either first or last name is required.
      type: object
      anyOf:
        - required: [firstName]
        - required: [lastName]
      properties:
        title:
          type: string
        firstName:
          type: string
        lastName:
          type: string
        middleName:
          type: string
        suffix:
          type: string
        nickname:
          type: string

    MaskedSubject:
      description: Mapping between a person's ID to their alias.
      type: object
      required:
        - subjectId
        - alias
      properties:
        subjectId:
          type: string
        alias:
          type: string

    Person:
      description: Mapping between a person's ID to their name(s).
      type: object
      required:
        - subjectId
        - name
      properties:
        subjectId:
          type: string
        name:
          oneOf:
            - type: string
            - $ref: "#/components/schemas/HumanName"
        aliases:
          type: array
          items:
            oneOf:
              - type: string
              - $ref: "#/components/schemas/HumanName"

    RedactionRequest:
      type: object
      required:
        - jurisdictionId
        - caseId
        - subjects
        - objects
      properties:
        jurisdictionId:
          type: string
        caseId:
          type: string
        subjects:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - role
              - subject
            properties:
              role:
                type: string
              subject:
                $ref: "#/components/schemas/Person"
        objects:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/RedactionTarget"
        outputFormat:
          type: string
          enum:
            - PDF
            - TEXT
            - HTML
            - JSON

    RedactionTarget:
      type: object
      required:
        - document
      properties:
        document:
          $ref: "#/components/schemas/InputDocument"
        callbackUrl:
          type: string
          format: uri
        targetBlobUrl:
          type: string
          format: uri

    ReviewTimestamps:
      type: object
      required:
        - pageOpen
        - decision
      properties:
        pageOpen:
          type: string
          format: date-time
        decision:
          type: string
          format: date-time

    FinalChargeOutcome:
      type: object
      required:
        - finalChargingDecision
      properties:
        finalChargingDecision:
          description: The final charging decision.
          type: string
          enum:
            - CHARGE
            - DECLINE
          example: CHARGE
        finalChargingDecisionExplanation:
          type: string
          maxLength: 4194303
          example: "The accused was caught on camera with the stolen goods."

    BlindDecisionOutcome:
      type: object
      required:
        - outcomeType
        - blindChargingDecision
      properties:
        outcomeType:
          type: string
          enum:
            - BLIND_DECISION
          example: BLIND_DECISION
        blindChargingDecision:
          description: The likely charging decision after blind review.
          type: string
          enum:
            - CHARGE_LIKELY
            - CHARGE_MAYBE
            - DECLINE_MAYBE
            - DECLINE_LIKELY
          example: CHARGE_LIKELY
        blindChargingDecisionExplanation:
          type: string
          maxLength: 4194303
          example: "The accused was caught on camera with the stolen goods."
        additionalEvidence:
          type: string
          maxLength: 4194303
          example: "The accused has a history of theft."

    DisqualifyingReason:
      type: string
      enum:
        - ASSIGNED_TO_UNBLIND
        - CASE_TYPE_INELIGIBLE
        - PRIOR_KNOWLEDGE_BIAS
        - NARRATIVE_INCOMPLETE
        - REDACTION_MISSING
        - REDACTION_ILLEGIBLE
        - OTHER

    DisqualifyOutcome:
      type: object
      required:
        - outcomeType
        - disqualifyingReason
      properties:
        outcomeType:
          type: string
          enum:
            - DISQUALIFICATION
          example: DISQUALIFICATION
        disqualifyingReason:
          oneOf:
            - $ref: "#/components/schemas/DisqualifyingReason"
              example: PRIOR_KNOWLEDGE_BIAS
            - type: array
              minItems: 1
              items:
                $ref: "#/components/schemas/DisqualifyingReason"
              example: [PRIOR_KNOWLEDGE_BIAS, OTHER]
        disqualifyingReasonExplanation:
          type: string
          maxLength: 4194303
          example: "I have prior knowledge of the individuals involved in this case."

    ReviewProtocol:
      type: string
      enum:
        - BLIND_REVIEW
        - FINAL_REVIEW

    BlindReviewDecision:
      type: object
      required:
        - protocol
        - outcome
      properties:
        protocol:
          type: string
          enum:
            - BLIND_REVIEW
          example: BLIND_REVIEW
        outcome:
          oneOf:
            - $ref: "#/components/schemas/BlindDecisionOutcome"
            - $ref: "#/components/schemas/DisqualifyOutcome"
          discriminator:
            propertyName: outcomeType
            mapping:
              BLIND_DECISION: "#/components/schemas/BlindDecisionOutcome"
              DISQUALIFICATION: "#/components/schemas/DisqualifyOutcome"

    FinalReviewDecision:
      type: object
      required:
        - protocol
        - outcome
      properties:
        protocol:
          type: string
          enum:
            - FINAL_REVIEW
          example: FINAL_REVIEW
        outcome:
          $ref: "#/components/schemas/FinalChargeOutcome"

    ReviewDecision:
      oneOf:
        - $ref: "#/components/schemas/BlindReviewDecision"
        - $ref: "#/components/schemas/FinalReviewDecision"
      discriminator:
        propertyName: protocol
        mapping:
          BLIND_REVIEW: "#/components/schemas/BlindReviewDecision"
          FINAL_REVIEW: "#/components/schemas/FinalReviewDecision"

    Exposure:
      type: object
      required:
        - jurisdictionId
        - caseId
        - subjectId
        - reviewingAttorneyMaskedId
        - documentIds
        - protocol
      properties:
        jurisdictionId:
          type: string
        caseId:
          type: string
        subjectId:
          oneOf:
            - type: string
            - type: array
              minItems: 1
              items:
                type: string
        reviewingAttorneyMaskedId:
          type: string
        documentIds:
          type: array
          minItems: 1
          items:
            type: string
        protocol:
          $ref: "#/components/schemas/ReviewProtocol"
        extra:
          type: string
          description: |
            Additional information about the exposure event.
            This field is optional and can be used to provide additional context.

    Review:
      type: object
      required:
        - jurisdictionId
        - caseId
        - subjectId
        - reviewingAttorneyMaskedId
        - documentIds
        - protocol
        - decision
        - timestamps
      properties:
        jurisdictionId:
          type: string
        caseId:
          type: string
        subjectId:
          oneOf:
            - type: string
            - type: array
              minItems: 1
              items:
                type: string
        reviewingAttorneyMaskedId:
          type: string
        documentIds:
          type: array
          minItems: 1
          items:
            type: string
        decision:
          $ref: "#/components/schemas/ReviewDecision"
        timestamps:
          $ref: "#/components/schemas/ReviewTimestamps"

    APIStatus:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string

    # --- Extraction schemas ---

    ExtractionInputDocument:
      description: |
        An input document for extraction. Only PDF documents are supported,
        provided either as a URL or base64-encoded content.
      oneOf:
        - $ref: "#/components/schemas/DocumentLink"
        - $ref: "#/components/schemas/DocumentContent"
      discriminator:
        propertyName: attachmentType
        mapping:
          LINK: "#/components/schemas/DocumentLink"
          BASE64: "#/components/schemas/DocumentContent"

    ExtractionTarget:
      type: object
      required:
        - document
      properties:
        document:
          $ref: "#/components/schemas/ExtractionInputDocument"
        callbackUrl:
          type: string
          format: uri

    ExtractionRequest:
      type: object
      required:
        - documents
      properties:
        documents:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/ExtractionTarget"

    ExtractionAccepted:
      type: object
      required:
        - tokens
      properties:
        tokens:
          description: |
            A list of opaque tokens, one per input document in the same order
            as the request. Each token can be used to poll for that document's
            extraction results via `GET /extract/{token}`.
          type: array
          items:
            type: string

    ExtractionStatus:
      description: |
        The status of a single document's extraction, returned when polling via token.
      type: object
      required:
        - token
        - result
      properties:
        token:
          type: string
        result:
          $ref: "#/components/schemas/ExtractionResult"

    ExtractionResultSuccess:
      type: object
      required:
        - extractedReport
        - status
      properties:
        extractedReport:
          $ref: "#/components/schemas/ExtractedReport"
        status:
          type: string
          enum:
            - COMPLETE

    ExtractionResultError:
      type: object
      required:
        - error
        - status
      properties:
        error:
          type: string
        status:
          type: string
          enum:
            - ERROR

    ExtractionResultPending:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum:
            - QUEUED
            - PROCESSING
        statusDetail:
          type: string

    ExtractionResultCompleted:
      description: |
        A completed extraction job, used in callbacks. The result is either
        a success with extracted data or an error.
      oneOf:
        - $ref: "#/components/schemas/ExtractionResultSuccess"
        - $ref: "#/components/schemas/ExtractionResultError"
      discriminator:
        propertyName: status
        mapping:
          COMPLETE: "#/components/schemas/ExtractionResultSuccess"
          ERROR: "#/components/schemas/ExtractionResultError"

    ExtractionResult:
      description: |
        Information about an extraction job, including pending states.
      oneOf:
        - $ref: "#/components/schemas/ExtractionResultSuccess"
        - $ref: "#/components/schemas/ExtractionResultError"
        - $ref: "#/components/schemas/ExtractionResultPending"
      discriminator:
        propertyName: status
        mapping:
          COMPLETE: "#/components/schemas/ExtractionResultSuccess"
          ERROR: "#/components/schemas/ExtractionResultError"
          QUEUED: "#/components/schemas/ExtractionResultPending"
          PROCESSING: "#/components/schemas/ExtractionResultPending"

    # --- Extracted report data model ---

    BoundingBox:
      description: A bounding rectangle defined by its top-left and bottom-right corners.
      type: object
      required:
        - x0
        - y0
        - x1
        - y1
      properties:
        x0:
          type: number
        y0:
          type: number
        x1:
          type: number
        y1:
          type: number

    DocumentRegion:
      description: A region within a specific page of a PDF document.
      type: object
      required:
        - page
        - bbox
      properties:
        page:
          type: integer
          minimum: 0
        bbox:
          $ref: "#/components/schemas/BoundingBox"

    CitedString:
      description: |
        A string value extracted from a document, paired with references to the
        document regions where the information was found. The `referenceIds` are
        indices into the top-level `references` array of the `ExtractedReport`.
      type: object
      required:
        - referenceIds
        - content
      properties:
        referenceIds:
          type: array
          items:
            type: integer
        content:
          type: string

    ExtractedCharge:
      type: object
      properties:
        statute:
          $ref: "#/components/schemas/CitedString"
        description:
          $ref: "#/components/schemas/CitedString"
        severity:
          $ref: "#/components/schemas/CitedString"
        class:
          $ref: "#/components/schemas/CitedString"

    ExtractedDefendant:
      type: object
      required:
        - charges
      properties:
        charges:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/ExtractedCharge"
        name:
          $ref: "#/components/schemas/CitedString"
        gender:
          $ref: "#/components/schemas/CitedString"
        weight:
          $ref: "#/components/schemas/CitedString"
        height:
          $ref: "#/components/schemas/CitedString"
        eyeColor:
          $ref: "#/components/schemas/CitedString"
        race:
          $ref: "#/components/schemas/CitedString"
        phoneNumber:
          $ref: "#/components/schemas/CitedString"
        address:
          $ref: "#/components/schemas/CitedString"

    ExtractedOfficer:
      type: object
      properties:
        name:
          $ref: "#/components/schemas/CitedString"
        agency:
          $ref: "#/components/schemas/CitedString"

    ExtractedPerson:
      type: object
      properties:
        name:
          $ref: "#/components/schemas/CitedString"
        status:
          description: The person's relationship to the case (e.g. victim, witness).
          $ref: "#/components/schemas/CitedString"

    IncidentMetadata:
      description: High-level metadata about the incident described in the report.
      type: object
      properties:
        agencyName:
          $ref: "#/components/schemas/CitedString"
        incidentNumber:
          $ref: "#/components/schemas/CitedString"
        incidentDate:
          $ref: "#/components/schemas/CitedString"

    ExtractedReport:
      description: |
        Structured information extracted from a police report PDF. The `references`
        array contains all document regions cited by the extracted fields. Each
        `CitedString` field contains `referenceIds` that are indices into this array.
      type: object
      required:
        - references
        - defendants
      properties:
        references:
          type: array
          items:
            $ref: "#/components/schemas/DocumentRegion"
        incident:
          $ref: "#/components/schemas/IncidentMetadata"
        defendants:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/ExtractedDefendant"
        referringOfficers:
          type: array
          items:
            $ref: "#/components/schemas/ExtractedOfficer"
        narratives:
          type: array
          items:
            $ref: "#/components/schemas/CitedString"
        otherPeople:
          type: array
          items:
            $ref: "#/components/schemas/ExtractedPerson"
